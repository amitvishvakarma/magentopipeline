<?php /** * CedCommerce * * NOTICE OF LICENSE * * This source file is subject to the End User License Agreement (EULA) * that is bundled with this package in the file LICENSE.txt. * It is also available through the world-wide-web at this URL: * https://cedcommerce.com/license-agreement.txt * * @category Ced * @package Ced_ConnectBase * @author CedCommerce Core Team <connect@cedcommerce.com> * @copyright Copyright CedCommerce (https://cedcommerce.com/) * @license https://cedcommerce.com/license-agreement.txt */ use Ced\ConnectBase\Block\Adminhtml\ProductLinking\AssignProducts; /** @var AssignProducts $block */ $allSkus = $block->getProductSkus(); $totalBatches = 0; $successImg = $block->getViewFileUrl('Ced_ConnectBase::images/fam_bullet_success.svg'); $errorImg = $block->getViewFileUrl('Ced_ConnectBase::images/fam_bullet_error.svg'); $loaderImg = $block->getViewFileUrl('Ced_ConnectBase::images/rule-ajax-loader.gif'); $noData = $block->getViewFileUrl('Ced_ConnectBase::images/no_data.gif'); $batchElements = []; ?> <div class="row"><div class="col-md-12" style="margin-top: 10px;"><div class="panel panel-default"><div class="block-content panel-body "><div id="connectbase-progress-bar"></div><br> <div id="batches"><div class="batches-content" data-role="content"><ul id="templates-row"><?php $totalBatches = $totalBatches + count($allSkus);?> <li id="template-name-default" class="template-name"><span>Template:</span> <span id="name"><b><?= /* @noEscape */ __('Default Template'); ?></b></span></li> <li id="template-products-default" class="template-products" data-template-id="default"><ul id="products-row" style="list-style: none;" data-total-batches="<?= /* @noEscape */ count($allSkus); ?>"><?php if (count($allSkus) > 0) { ?> <li style="list-style: none; margin-left: 10px"><?= /* @noEscape */ 'Total ' . count($allSkus) . ' Batch(s) Found.'; ?></li> <?php } else { ?> <li style="list-style: none; margin-left: 10px"><?= /* @noEscape */ 'No batches found for processing'; ?></li> <?php } ?> <?php foreach ($allSkus as $index => $productsBatch) { ?> <?php $batchElements[] = 'product-batch-' . $index?> <li class="product-batch" style="list-style: none; margin-left: 10px" id="product-batch-<?= /* @noEscape */ $index ?>" data-ajax-completed="0" data-batch-type="product" data-batch-index="<?= /* @noEscape */ $index?>" data-product-skus='<?= /* @noEscape */ json_encode($productsBatch)?>'><img id="status-image-<?= /* @noEscape */ $index ?>" src="<?= /* @noEscape */ $loaderImg ?>"><span id="status-message-<?= /* @noEscape */ $index ?>" class="text"><?= /* @noEscape */ __("Updating..."); ?></span></li> <?php } ?> <li id="liFinished" style="display:none; list-style: none;"><?= /* @noEscape */ __("Template processing finished."); ?></li></ul></li> <?php if (empty($allSkus)) { ?> <li style="list-style: none; padding: 1.5rem"><img id="status-image-no-data" style="max-width: 5%" src="<?= /* @noEscape */ $noData ?>" alt=""><span style="font-size: 1.6rem"><?= /* @noEscape */ _('No Data found for processing'); ?></span></li> <?php } ?> <input id="total-batches" type="hidden" value="<?= /* @noEscape */ $totalBatches;?>"/></ul></div></div></div></div></div></div><script>
    require([
            'jquery',
            'jquery/ui',
            'accordion',
            'lineProgressbar'
        ],
        function ($) {

            
            let productsListSelector = $(".template-products");
            let currentBatch = 1;
            let totalBatches = parseInt($('#total-batches').val());
            let batches = [];

            if (totalBatches > 0) {
                let progressBarSelector = $("#connectbase-progress-bar");
                progressBarSelector.LineProgressbar({
                    percentage: 0,
                    fillBackgroundColor: '#77a21b',
                    height: '25px',
                    progressBarWidth: 0
                });
                batches = <?= /* @noEscape */ json_encode($batchElements); ?>;

                processRequest(currentBatch, totalBatches);
            }

            function processRequest(currentBatch, totalBatches) {
                if (batches.length > 0) {
                    let batchElement = $('#' + batches[0]);
                    let progressBarSelector = $("#connectbase-progress-bar");
                    let productSkus = $(batchElement).data('product-skus');
                    let batchIndex = $(batchElement).data('batch-index');
                    $.ajax({
                        type: "POST",
                        url: "<?= /* @noEscape */$block->getAjaxUrl();?>",
                        data: {
                            product_skus: productSkus,
                            marketplace_id: '<?= /* @noEscape */ $block->getMarketplaceId(); ?>',
                            form_key: window.FORM_KEY
                        },
                        dataType: "json",
                        success: function (response) {
                            $("#status-message-" + batchIndex).text(response.message)
                            if (response.success === true) {
                                $("#status-image-" + batchIndex).attr('src', '<?=  /* @noEscape */ $successImg ?>');
                            } else if (response.success === false) {
                                $("#status-image-" + batchIndex).attr('src', '<?=  /* @noEscape */ $errorImg ?>');
                                $("#status-message-" + batchIndex).text(response.message)
                            } else {
                                $("#status-image-" + batchIndex).attr('src', '<?=  /* @noEscape */ $errorImg ?>');
                                $("#status-message-" + batchIndex).text('Something went wrong')
                            }
                        },
                        error: function () {
                            $("#status-message-" + batchIndex).text('Something went wrong')
                            $("#status-image-" + batchIndex).attr('src', '<?=  /* @noEscape */ $errorImg ?>');
                        },
                        complete: function () {
                            progressBarSelector.LineProgressbar({
                                percentage: parseInt((currentBatch / totalBatches) * 100),
                                fillBackgroundColor: '#77a21b',
                                height: '35px',
                                progressBarWidth: parseInt((currentBatch / totalBatches) * 100)
                            });
                            currentBatch = currentBatch + 1;
                            batches.splice($.inArray(batches[0], batches), 1);
                            processRequest(currentBatch, totalBatches);
                        }
                    });
                }
            }

        }
    );</script><style> #batches { border: 1px solid #ddd; border-radius: 0; } .batches-tab { background: #eee; padding: 1rem; cursor: pointer; font-weight: bold; & :first-child { border-bottom: 1px solid #ddd; } & :nth-last-child(2) { border-top: 1px solid #ddd; } } .batches-content { padding: 0.5rem 0.5rem; } /*li*/ #batches ul { list-style: none; padding: 0; margin: 0; } #batches ul li { vertical-align: middle; padding: 2px 2px 2px 2px; font: normal 12px sans-serif; font-size: 1.5rem; } #batches li img { vertical-align: middle; margin-right: 5px; max-width: 1.5rem; } #batches span { vertical-align: middle; }</style>